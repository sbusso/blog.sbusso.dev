<p>EasyEngine did switch from installing php stack directly to the system to use docker images to create the different environments, but using command line. Using Portainer, we can skip those steps and manage deployment directly from the interface and control everything. But first we need to setup the system:</p><div class="heading-wrapper h2"><h2 id="system-installation">System installation</h2><a class="anchor" href="#system-installation" aria-labelledby="system-installation"><span hidden>#</span></a></div><p>Create a VPS with Ubuntu 20.04 LTS</p><div class="heading-wrapper h3"><h3 id="install-webminvirtualmin">Install webmin/virtualmin</h3><a class="anchor" href="#install-webminvirtualmin" aria-labelledby="install-webminvirtualmin"><span hidden>#</span></a></div><p>(optional)</p><pre class="language-shell"><code class="language-shell">	<span class="token function">wget</span> http://software.virtualmin.com/gpl/scripts/install.sh<br>	<span class="token function">sudo</span> /bin/sh install.sh</code></pre><div class="heading-wrapper h3"><h3 id="install-portainer">Install Portainer</h3><a class="anchor" href="#install-portainer" aria-labelledby="install-portainer"><span hidden>#</span></a></div><p>(required)</p><pre class="language-shell"><code class="language-shell">	<span class="token function">apt</span> update<br>	<span class="token function">apt</span> upgrade<br>	<span class="token function">apt</span> <span class="token function">install</span> docker.io<br>	docker volume create portainer_data<br>	docker run -d -p <span class="token number">8000</span>:8000 -p <span class="token number">9000</span>:9000 --name<span class="token operator">=</span>portainer --restart<span class="token operator">=</span>always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</code></pre><div class="heading-wrapper h2"><h2 id="setup-layers">Setup layers</h2><a class="anchor" href="#setup-layers" aria-labelledby="setup-layers"><span hidden>#</span></a></div><div class="heading-wrapper h3"><h3 id="network">Network</h3><a class="anchor" href="#network" aria-labelledby="network"><span hidden>#</span></a></div><p>We need 2 network, one to deal with outside world, managed by traefik, and another one for backend communication with the dabatabse, not accessible from outside will be created by each stack.</p><pre><code>docker create network -d bridge traefik
</code></pre><p>Each stack will create their own network.</p><p>Or directly in the UI:</p><p>Then we need to install 2 pieces of infra: the router / load blancer, Treafik, and the datbase mariadb.</p><div class="heading-wrapper h3"><h3 id="traefik">traefik</h3><a class="anchor" href="#traefik" aria-labelledby="traefik"><span hidden>#</span></a></div><p>At the moment portainer only accept docker compose v2 definition</p><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"2"</span><br><br><span class="token key atrule">services</span><span class="token punctuation">:</span><br>  <span class="token key atrule">traefik</span><span class="token punctuation">:</span><br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"traefik:v2.3"</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> <span class="token string">"traefik"</span><br>    <span class="token key atrule">command</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">"--api.insecure=true"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--providers.docker=true"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--providers.docker.exposedbydefault=false"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--entrypoints.web.address=:80"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--entrypoints.web-secure.address=:443"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--certificatesresolvers.myhttpchallenge.acme.httpchallenge=true"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--certificatesresolvers.myhttpchallenge.acme.httpchallenge.entrypoint=web"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--pilot.token=df5c63a6-9fc1-4253-9c36-62f0ed4548c1"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--certificatesresolvers.myhttpchallenge.acme.email=stephane.busso@gmail.com"</span><br>      <span class="token punctuation">-</span> <span class="token string">"--certificatesresolvers.myhttpchallenge.acme.storage=/letsencrypt/acme.json"</span>            <br>    <span class="token key atrule">ports</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">"80:80"</span><br>      <span class="token punctuation">-</span> <span class="token string">"443:443"</span><br>      <span class="token punctuation">-</span> <span class="token string">"8080:8080"</span><br>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">"/var/run/docker.sock:/var/run/docker.sock:ro"</span><br>      <span class="token punctuation">-</span> <span class="token string">"/etc/letsencrypt:/letsencrypt"</span><br>    <span class="token key atrule">networks</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> traefik<br><br><span class="token key atrule">networks</span><span class="token punctuation">:</span><br>  <span class="token key atrule">traefik</span><span class="token punctuation">:</span><br>    <span class="token key atrule">external</span><span class="token punctuation">:</span><br>      <span class="token key atrule">name</span><span class="token punctuation">:</span> traefik</code></pre><div class="heading-wrapper h3"><h3 id="wordpress-stack">Wordpress stack</h3><a class="anchor" href="#wordpress-stack" aria-labelledby="wordpress-stack"><span hidden>#</span></a></div><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"2"</span><br><br><span class="token key atrule">services</span><span class="token punctuation">:</span><br>  <span class="token key atrule">db</span><span class="token punctuation">:</span><br>     <span class="token key atrule">image</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">:</span>latest<br>     <span class="token key atrule">volumes</span><span class="token punctuation">:</span><br>       <span class="token punctuation">-</span> /var/lib/mysql<span class="token punctuation">:</span>/var/lib/mysql<span class="token punctuation">:</span>/var/lib/mysql<br>     <span class="token key atrule">restart</span><span class="token punctuation">:</span> always<br>     <span class="token key atrule">environment</span><span class="token punctuation">:</span><br>       <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> PASSWORD<br>       <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> WP<br>       <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> WPUSER<br>       <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> WPPASSWD<br>     <span class="token key atrule">networks</span><span class="token punctuation">:</span><br>       <span class="token punctuation">-</span> backend<br>  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span><br>     <span class="token key atrule">depends_on</span><span class="token punctuation">:</span><br>       <span class="token punctuation">-</span> db<br>     <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress <span class="token comment"># wordpress with apache</span><br>     <span class="token key atrule">restart</span><span class="token punctuation">:</span> always<br>     <span class="token key atrule">environment</span><span class="token punctuation">:</span><br>       <span class="token key atrule">WORDPRESS_DB_HOST</span><span class="token punctuation">:</span> db<span class="token punctuation">:</span><span class="token number">3306</span><br>       <span class="token key atrule">WORDPRESS_DB_USER</span><span class="token punctuation">:</span> WPUSER<br>       <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span> WPPASSWD<br>     <span class="token key atrule">networks</span><span class="token punctuation">:</span><br>       <span class="token punctuation">-</span> traefik<br>       <span class="token punctuation">-</span> backend<br>     <span class="token key atrule">labels</span><span class="token punctuation">:</span><br>      <span class="token comment"># The labels are usefull for Traefik only</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.enable=true"</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.docker.network=traefik_default"</span><br>      <span class="token comment"># Get the routes from http</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.http.routers.${SERVICE}.rule=Host(`${DOMAIN}`)"</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.http.routers.${SERVICE}.entrypoints=web"</span><br>      <span class="token comment"># Redirect these routes to https</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.http.routers.${SERVICE}.middlewares=redirect-to-https@docker"</span><br>      <span class="token comment"># Get the routes from https</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.http.routers.${SERVICE}-secured.rule=Host(`${DOMAIN}`)"</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.http.routers.${SERVICE}-secured.entrypoints=web-secure"</span><br>      <span class="token comment"># Apply autentificiation with http challenge</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.http.routers.${SERVICE}-secured.tls=true"</span><br>      <span class="token punctuation">-</span> <span class="token string">"traefik.http.routers.${SERVICE}-secured.tls.certresolver=myhttpchallenge"</span><br><span class="token key atrule">volumes</span><span class="token punctuation">:</span><br>    <span class="token key atrule">db_data</span><span class="token punctuation">:</span><br><br><span class="token key atrule">networks</span><span class="token punctuation">:</span><br>  <span class="token key atrule">traefik</span><span class="token punctuation">:</span><br>    <span class="token key atrule">external</span><span class="token punctuation">:</span><br>      <span class="token key atrule">name</span><span class="token punctuation">:</span> traefik<br>  <span class="token key atrule">backend</span><span class="token punctuation">:</span></code></pre><p><em>Voilà</em>, after few minutes (time for traefik to get certificates) you should be able to access wordpress at the address in <code>DOMAIN</code></p><div class="heading-wrapper h2"><h2 id="conclusion">Conclusion</h2><a class="anchor" href="#conclusion" aria-labelledby="conclusion"><span hidden>#</span></a></div><p>What I have learned, it is not always good to optimise things,different paradigm, containers have to keep simple and indempotent, 1 database per stack instead of 1 central and fpm vs apache/php was too complex to operate.</p>